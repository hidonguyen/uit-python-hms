<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>HMS ¬∑ Liquid Glass Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      html {
        font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
      }
      :root {
        color-scheme: light dark;
      }
      /* Liquid animated blobs */
      .blob {
        filter: blur(60px);
        opacity: 0.6;
        animation: float 16s ease-in-out infinite;
      }
      .blob2 {
        animation-duration: 22s;
      }
      .blob3 {
        animation-duration: 28s;
      }
      @keyframes float {
        0%,
        100% {
          transform: translate(0, 0) scale(1);
        }
        50% {
          transform: translate(20px, -25px) scale(1.05);
        }
      }
      /* Soft noise */
      .noise:before {
        content: "";
        position: fixed;
        inset: -50%;
        pointer-events: none;
        z-index: -1;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.025'/%3E%3C/svg%3E");
      }
      /* Glass cards */
      .glass {
        backdrop-filter: saturate(140%) blur(14px);
        -webkit-backdrop-filter: saturate(140%) blur(14px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .dark .glass {
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
      }
      /* Neon focus ring */
      .ring-neon:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.55),
          0 0 0 6px rgba(20, 184, 166, 0.25);
      }
      /* Progress bar */
      .nprogress {
        position: fixed;
        left: 0;
        top: 0;
        height: 3px;
        width: 0;
        background: linear-gradient(90deg, #22d3ee, #a78bfa, #60a5fa);
        transition: width 0.3s ease;
        z-index: 60;
      }
      /* Enter motion */
      @keyframes cardIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .enter {
        animation: cardIn 0.5s ease forwards;
      }
    </style>
  </head>
  <body
    class="relative min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 noise"
  >
    <!-- animated gradient blobs -->
    <div class="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
      <div
        class="blob absolute -top-16 -left-10 w-[40rem] h-[40rem] rounded-full bg-gradient-to-br from-cyan-400 via-indigo-400 to-fuchsia-400 opacity-40"
      ></div>
      <div
        class="blob blob2 absolute -bottom-24 -right-20 w-[42rem] h-[42rem] rounded-full bg-gradient-to-tr from-violet-500 via-sky-400 to-teal-300 opacity-40"
      ></div>
      <div
        class="blob blob3 absolute top-1/3 left-1/2 -translate-x-1/2 w-[34rem] h-[34rem] rounded-full bg-gradient-to-tr from-rose-400 via-amber-300 to-emerald-300 opacity-30"
      ></div>
    </div>

    <div id="bar" class="nprogress"></div>

    <!-- Header -->
    <header
      class="sticky top-0 z-50 backdrop-blur-xl bg-white/50 dark:bg-slate-900/40 glass"
    >
      <div
        class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <span class="text-xl sm:text-2xl font-extrabold tracking-tight"
            >üßä HMS Dashboard</span
          >
          <span
            id="rangeLabel"
            class="hidden md:inline text-xs px-2 py-1 rounded-full bg-white/60 dark:bg-slate-800/60 border border-white/40 dark:border-slate-700/60 glass"
          ></span>
        </div>
        <div class="flex items-center gap-2">
          <a
            href="http://127.0.0.1:8000/docs"
            target="_blank"
            class="hidden md:inline text-xs px-2 py-1 rounded-full bg-white/60 dark:bg-slate-900/50 hover:bg-white/80 dark:hover:bg-slate-900/70 transition border border-white/40 dark:border-slate-700/60"
            >API Docs</a
          >
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
      <!-- Filters -->
      <section
        class="glass rounded-2xl p-4 sm:p-5 bg-white/50 dark:bg-slate-900/40 enter"
      >
        <div
          class="flex flex-col lg:flex-row gap-4 lg:items-end lg:justify-between"
        >
          <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 w-full">
            <div class="sm:col-span-2">
              <label class="block text-xs font-semibold mb-1 opacity-80"
                >T·ª´ ng√†y</label
              >
              <input
                id="startDate"
                type="date"
                class="w-full rounded-xl bg-white/80 dark:bg-slate-900/60 border border-white/50 dark:border-slate-700/70 px-3 py-2 ring-neon"
              />
            </div>
            <div class="sm:col-span-2">
              <label class="block text-xs font-semibold mb-1 opacity-80"
                >ƒê·∫øn ng√†y</label
              >
              <input
                id="endDate"
                type="date"
                class="w-full rounded-xl bg-white/80 dark:bg-slate-900/60 border border-white/50 dark:border-slate-700/70 px-3 py-2 ring-neon"
              />
            </div>
            <div class="sm:col-span-1 flex items-end gap-2">
              <button
                id="reloadBtn"
                class="w-full px-4 py-2 rounded-xl text-sm font-semibold text-white bg-gradient-to-r from-indigo-500 via-cyan-400 to-emerald-400 hover:brightness-110 active:scale-[.99] transition ring-neon"
              >
                T·∫£i d·ªØ li·ªáu
              </button>
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button
              class="px-3 py-1.5 text-xs rounded-full border border-white/50 dark:border-slate-700/60 bg-white/60 dark:bg-slate-900/50"
              data-preset="month"
            >
              Th√°ng n√†y
            </button>
            <button
              class="px-3 py-1.5 text-xs rounded-full border border-white/50 dark:border-slate-700/60 bg-white/60 dark:bg-slate-900/50"
              data-preset="quarter"
            >
              Qu√Ω n√†y
            </button>
            <button
              class="px-3 py-1.5 text-xs rounded-full border border-white/50 dark:border-slate-700/60 bg-white/60 dark:bg-slate-900/50"
              data-preset="year"
            >
              NƒÉm nay
            </button>
          </div>
        </div>
      </section>

      <!-- KPIs -->
      <section
        id="kpiSection"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"
      ></section>

      <!-- Charts row -->
      <section class="grid grid-cols-1 xl:grid-cols-3 gap-4">
        <div
          class="glass bg-white/50 dark:bg-slate-900/40 rounded-2xl p-4 sm:p-5 xl:col-span-2 enter"
        >
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">Bookings theo ng√†y</h2>
            <span id="bookingTotal" class="text-xs opacity-80"></span>
          </div>
          <div class="relative h-[360px]">
            <canvas id="bookingsChart"></canvas>
          </div>
        </div>
        <div
          class="glass bg-white/50 dark:bg-slate-900/40 rounded-2xl p-4 sm:p-5 enter"
        >
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">Ph√¢n b·ªï kh√°ch h√†ng</h2>
          </div>
          <div id="customerDist" class="grid grid-cols-1 gap-4"></div>
        </div>
      </section>

      <!-- Revenue cards -->
      <section class="grid grid-cols-1 xl:grid-cols-2 gap-4">
        <!-- Room type PIE -->
        <div
          class="glass bg-white/50 dark:bg-slate-900/40 rounded-2xl p-4 sm:p-5 enter"
        >
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Doanh thu theo lo·∫°i ph√≤ng</h2>
            <span id="roomTypeTotal" class="text-xs opacity-80"></span>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-center">
            <div class="relative h-[260px]">
              <canvas id="roomTypeChart"></canvas>
            </div>
            <div id="roomTypeLegend" class="space-y-2"></div>
          </div>
        </div>
        <!-- Service revenue BAR -->
        <div
          class="glass bg-white/50 dark:bg-slate-900/40 rounded-2xl p-4 sm:p-5 enter"
        >
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Doanh thu d·ªãch v·ª•</h2>
            <span id="serviceTotal" class="text-xs opacity-80"></span>
          </div>
          <div class="relative h-[260px]">
            <canvas id="serviceChart"></canvas>
          </div>
        </div>
      </section>

      <!-- Log -->
      <section
        class="glass bg-white/50 dark:bg-slate-900/40 rounded-2xl p-4 sm:p-5 enter"
      >
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">Log</h2>
        </div>
        <pre
          id="log"
          class="text-xs bg-white/40 dark:bg-slate-900/40 rounded-xl p-3 max-h-60 overflow-auto"
        ></pre>
      </section>
    </main>

    <script>
      /* ================== CONFIG ================== */
      const API_BASE = "http://127.0.0.1:8000";
      const EP = {
        summary: "/api/reports/summary",
        roomType: "/api/reports/revenue-by-room-type",
        service: "/api/reports/service-revenue",
        customers: "/api/reports/customer-distribution",
        bookings: "/api/reports/bookings-per-day",
      };
      const COLORS = [
        "#60a5f6",
        "#34d399",
        "#f59e0b",
        "#a78bfa",
        "#fb7185",
        "#22d3ee",
      ];

      /* ================== HELPERS ================== */
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      const pad = (n) => String(n).padStart(2, "0");
      const ymd = (d) =>
        `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
      const ymdToDMY = (v) => (v ? v.split("-").reverse().join("-") : "");
      const fmtVND = (n) => (n ?? 0).toLocaleString("vi-VN") + " ‚Ç´";
      const fmtNum = (n) => (n ?? 0).toLocaleString("vi-VN");
      const fmtPct = (p) => `${(p ?? 0).toFixed(1)}%`;
      const log = (m, d) => {
        $("#log").textContent =
          `[${new Date().toLocaleTimeString()}] ${m}${
            d ? " " + JSON.stringify(d) : ""
          }\n` + $("#log").textContent;
      };
      const bar = {
        start() {
          $("#bar").style.width = "30%";
        },
        tick(v) {
          $("#bar").style.width = v + "%";
        },
        done() {
          $("#bar").style.width = "100%";
          setTimeout(() => ($("#bar").style.width = "0"), 350);
        },
      };
      let aborter = null,
        charts = { bookings: null, roomType: null, service: null };

   

      /* ================== UI BUILDERS ================== */
      function skeletonKPIs() {
        $("#kpiSection").innerHTML = Array.from({ length: 4 })
          .map(
            () => `
    <div class="glass rounded-2xl p-4 bg-white/50 dark:bg-slate-900/40">
      <div class="h-3 w-24 rounded bg-white/60 dark:bg-slate-700/60 mb-2"></div>
      <div class="h-9 w-40 rounded bg-white/70 dark:bg-slate-800/70"></div>
    </div>`
          )
          .join("");
      }
      function setKPIs(s) {
        const items = [
          { label: "T·ªïng doanh thu", val: fmtVND(s.total_revenue) },
          { label: "Doanh thu ph√≤ng", val: fmtVND(s.room_revenue) },
          { label: "Doanh thu d·ªãch v·ª•", val: fmtVND(s.service_revenue) },
          { label: "T·ªïng kh√°ch", val: fmtNum(s.total_guests) },
        ];
        $("#kpiSection").innerHTML = items
          .map(
            (k, i) => `
    <div class="glass rounded-2xl p-4 bg-white/50 dark:bg-slate-900/40 enter" style="animation-delay:${
      i * 80
    }ms">
      <div class="text-xs opacity-80">${k.label}</div>
      <div class="text-3xl font-extrabold mt-1 tracking-tight">${k.val}</div>
    </div>`
          )
          .join("");
      }
      function legendList(container, items, total) {
        $(container).innerHTML = items
          .map(
            (it, i) => `
    <div class="flex items-center justify-between text-sm">
      <div class="flex items-center gap-2">
        <span class="inline-block w-3 h-3 rounded-full" style="background:${
          COLORS[i % COLORS.length]
        }"></span>
        <span>${it.name}</span>
      </div>
      <div class="tabular-nums">${fmtVND(
        it.revenue
      )} ¬∑ <span class="opacity-80">${fmtPct(it.percent)}</span></div>
    </div>`
          )
          .join("");
      }
      function setCustomerDist(d) {
        $("#customerDist").innerHTML = [
          {
            n: "Kh√°ch m·ªõi",
            v: d.new_customers,
            p: d.percent_new,
            c: COLORS[1],
          },
          {
            n: "Kh√°ch quay l·∫°i",
            v: d.returning_customers,
            p: d.percent_returning,
            c: COLORS[3],
          },
        ]
          .map(
            (x) => `
    <div class="glass rounded-xl p-4 bg-white/50 dark:bg-slate-900/40">
      <div class="text-xs opacity-80">${x.n}</div>
      <div class="text-3xl font-extrabold">${fmtNum(x.v)}</div>
      <div class="mt-2 flex items-center gap-2">
        <div class="h-2 flex-1 rounded-full bg-white/50 dark:bg-slate-800/70 overflow-hidden">
          <div class="h-2 rounded-full" style="width:${x.p}%; background:${
              x.c
            }; box-shadow:0 0 14px ${x.c}66"></div>
        </div>
        <span class="text-xs opacity-80 w-14 text-right">${fmtPct(x.p)}</span>
      </div>
    </div>`
          )
          .join("");
      }

      /* ================== CHARTS ================== */
      function drawBookings(data) {
        const ctx = $("#bookingsChart").getContext("2d");
        const grad = ctx.createLinearGradient(0, 0, 0, 320);
        grad.addColorStop(0, "rgba(96,165,246,.45)");
        grad.addColorStop(1, "rgba(96,165,246,0)");
        if (charts.bookings) charts.bookings.destroy();
        charts.bookings = new Chart(ctx, {
          type: "line",
          data: {
            labels: data.points.map((p) => p.date),
            datasets: [
              {
                label: "Bookings",
                data: data.points.map((p) => p.bookings),
                borderColor: "#60a5f6",
                backgroundColor: grad,
                tension: 0.35,
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: { label: (c) => `${c.parsed.y} bookings` },
              },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 },
              },
              y: {
                beginAtZero: true,
                ticks: { precision: 0 },
                grid: {
                  color: document.documentElement.classList.contains("dark")
                    ? "rgba(255,255,255,0.1)"
                    : "rgba(0,0,0,0.06)",
                },
              },
            },
          },
        });
        $("#bookingTotal").textContent = `T·ªïng booking: ${fmtNum(data.total)}`;
      }

      function drawRoomTypePie(roomType) {
        const ctx = $("#roomTypeChart").getContext("2d");
        if (charts.roomType) charts.roomType.destroy();
        charts.roomType = new Chart(ctx, {
          type: "pie",
          data: {
            labels: roomType.items.map((i) => i.name),
            datasets: [
              {
                data: roomType.items.map((i) => i.revenue),
                backgroundColor: roomType.items.map(
                  (_, i) => COLORS[i % COLORS.length]
                ),
                borderWidth: 1,
              },
            ],
          },
          options: {
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (c) =>
                    `${c.label}: ${fmtVND(c.parsed)} (${fmtPct(
                      roomType.items[c.dataIndex].percent
                    )})`,
                },
              },
            },
          },
        });
        $("#roomTypeTotal").textContent = "T·ªïng: " + fmtVND(roomType.total);
        legendList("#roomTypeLegend", roomType.items, roomType.total);
      }

      function drawServiceBar(service) {
        const ctx = $("#serviceChart").getContext("2d");
        if (charts.service) charts.service.destroy();
        charts.service = new Chart(ctx, {
          type: "bar",
          data: {
            labels: service.items.map((i) => i.name),
            datasets: [
              {
                data: service.items.map((i) => i.revenue),
                label: "Doanh thu",
                borderWidth: 1,
                backgroundColor: service.items.map(
                  (_, i) => COLORS[i % COLORS.length]
                ),
              },
            ],
          },
          options: {
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (c) => fmtVND(c.parsed.y) } },
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                beginAtZero: true,
                ticks: { callback: (v) => v / 1_000_000 + "m" },
                grid: {
                  color: document.documentElement.classList.contains("dark")
                    ? "rgba(255,255,255,0.1)"
                    : "rgba(0,0,0,0.06)",
                },
              },
            },
          },
        });
        $("#serviceTotal").textContent = "T·ªïng: " + fmtVND(service.total);
      }

      /* ================== FETCH ================== */
      const get = async (path, params, signal) => {
        const url = `${API_BASE}${path}?${new URLSearchParams(params)}`;
        log("GET " + url);
        const res = await fetch(url, { signal });
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        return res.json();
      };

      async function loadAll() {
        if (aborter) aborter.abort();
        aborter = new AbortController();
        const { signal } = aborter;
        skeletonKPIs();
        bar.start();
        $("#reloadBtn").disabled = true;

        const q = {
          start_date: ymdToDMY($("#startDate").value),
          end_date: ymdToDMY($("#endDate").value),
        };
        $("#rangeLabel").textContent = `${q.start_date} ‚Üí ${q.end_date}`;

        try {
          bar.tick(55);
          const [summary, roomType, service, customers, bookings] =
            await Promise.all([
              get(EP.summary, q, signal),
              get(EP.roomType, q, signal),
              get(EP.service, q, signal),
              get(EP.customers, q, signal),
              get(EP.bookings, q, signal),
            ]);
          setKPIs(summary);
          setCustomerDist(customers);
          drawBookings({
            total: bookings.total,
            points: (bookings.points || []).map((p) => ({
              date:
                typeof p.date === "string"
                  ? p.date
                  : new Date(p.date).toISOString().slice(0, 10),
              bookings: p.bookings,
            })),
          });
          drawRoomTypePie(roomType);
          drawServiceBar(service);
          bar.done();
        } catch (e) {
          if (e.name !== "AbortError") {
            log("ERROR", { msg: e.message });
            alert("L·ªói t·∫£i d·ªØ li·ªáu: " + e.message);
          }
          bar.done();
        } finally {
          $("#reloadBtn").disabled = false;
        }
      }

      /* ================== PRESETS / INIT ================== */
      function setPreset(type) {
        const now = new Date();
        let s, e;
        if (type === "month") {
          s = new Date(now.getFullYear(), now.getMonth(), 1);
          e = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        } else if (type === "quarter") {
          const q = Math.floor(now.getMonth() / 3);
          s = new Date(now.getFullYear(), q * 3, 1);
          e = new Date(now.getFullYear(), q * 3 + 3, 0);
        } else {
          s = new Date(now.getFullYear(), 0, 1);
          e = new Date(now.getFullYear(), 11, 31);
        }
        $("#startDate").value = ymd(s);
        $("#endDate").value = ymd(e);
        loadAll();
      }

      let typing;
      (function init() {
        // default range
        $("#startDate").value = "2025-01-01";
        $("#endDate").value = "2025-12-31";
        $("#reloadBtn").addEventListener("click", loadAll);
        $$("[data-preset]").forEach((b) =>
          b.addEventListener("click", () => setPreset(b.dataset.preset))
        );
        ["#startDate", "#endDate"].forEach((sel) =>
          $(sel).addEventListener("input", () => {
            clearTimeout(typing);
            typing = setTimeout(loadAll, 400);
          })
        );
        loadAll();
      })();
    </script>
  </body>
</html>
